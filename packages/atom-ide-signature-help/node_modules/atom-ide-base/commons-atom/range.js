"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.isPositionInRange = exports.matchRegexEndingAt = exports.wordAtPositionFromBuffer = exports.getWordFromCursorOrSelection = exports.getWordFromMouseEvent = exports.trimRange = exports.wordAtPosition = void 0;
const atom_1 = require("atom");
const assert_1 = __importDefault(require("assert"));
function wordAtPosition(editor, position, wordRegex) {
    let wordRegex_;
    if (wordRegex instanceof RegExp) {
        wordRegex_ = wordRegex;
    }
    else {
        const nonWordChars = editor.getNonWordCharacters(position);
        const escaped = nonWordChars.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&");
        let r = `^[\t ]*$|[^\\s${escaped}]+`;
        if (wordRegex == null || wordRegex.includeNonWordCharacters) {
            r += `|[${escaped}]+`;
        }
        wordRegex_ = new RegExp(r, "g");
    }
    return wordAtPositionFromBuffer(editor.getBuffer(), position, wordRegex_);
}
exports.wordAtPosition = wordAtPosition;
function trimRange(editor, rangeToTrim, stopRegex = /\S/) {
    const buffer = editor.getBuffer();
    let { start, end } = rangeToTrim;
    buffer.scanInRange(stopRegex, rangeToTrim, ({ range, stop }) => {
        start = range.start;
        stop();
    });
    buffer.backwardsScanInRange(stopRegex, rangeToTrim, ({ range, stop }) => {
        end = range.end;
        stop();
    });
    return new atom_1.Range(start, end);
}
exports.trimRange = trimRange;
function getSingleWordAtPosition(editor, position) {
    const match = wordAtPosition(editor, position);
    if (match == null || match.wordMatch.length !== 1) {
        return null;
    }
    return match.wordMatch[0];
}
function getWordFromMouseEvent(editor, event) {
    const component = editor.getElement().component;
    assert_1.default(component);
    const point = component.screenPositionForMouseEvent(event);
    return getSingleWordAtPosition(editor, point);
}
exports.getWordFromMouseEvent = getWordFromMouseEvent;
function getWordFromCursorOrSelection(editor) {
    const selection = editor.getSelectedText();
    if (selection && selection.length > 0) {
        return selection;
    }
    const point = editor.getCursorScreenPosition();
    return getSingleWordAtPosition(editor, point);
}
exports.getWordFromCursorOrSelection = getWordFromCursorOrSelection;
function wordAtPositionFromBuffer(buffer, position, wordRegex) {
    const { row, column } = position;
    const rowRange = buffer.rangeForRow(row);
    let matchData;
    buffer.scanInRange(wordRegex, rowRange, (data) => {
        const { range } = data;
        if (range.start.isLessThanOrEqual(position) && range.end.isGreaterThan(position)) {
            matchData = data;
        }
        if (range.end.column > column) {
            data.stop();
        }
    });
    if (matchData) {
        return {
            wordMatch: matchData.match,
            range: matchData.range,
        };
    }
    else {
        return null;
    }
}
exports.wordAtPositionFromBuffer = wordAtPositionFromBuffer;
function matchRegexEndingAt(buffer, endPosition, regex) {
    const line = buffer.getTextInRange([[endPosition.row, 0], endPosition]);
    const match = regex.exec(line);
    return match == null ? null : match[0];
}
exports.matchRegexEndingAt = matchRegexEndingAt;
function isPositionInRange(position, range) {
    return Array.isArray(range) ? range.some((r) => r.containsPoint(position)) : range.containsPoint(position);
}
exports.isPositionInRange = isPositionInRange;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZ2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMtY29tbW9ucy1hdG9tL3JhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLCtCQUFnRjtBQUNoRixvREFBOEI7QUFROUIsU0FBZ0IsY0FBYyxDQUM1QixNQUFrQixFQUNsQixRQUFlLEVBQ2YsU0FBMEQ7SUFFMUQsSUFBSSxVQUFVLENBQUE7SUFDZCxJQUFJLFNBQVMsWUFBWSxNQUFNLEVBQUU7UUFDL0IsVUFBVSxHQUFHLFNBQVMsQ0FBQTtLQUN2QjtTQUFNO1FBTUwsTUFBTSxZQUFZLEdBQVcsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2xFLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFLckUsSUFBSSxDQUFDLEdBQUcsaUJBQWlCLE9BQU8sSUFBSSxDQUFBO1FBQ3BDLElBQUksU0FBUyxJQUFJLElBQUksSUFBSSxTQUFTLENBQUMsd0JBQXdCLEVBQUU7WUFDM0QsQ0FBQyxJQUFJLEtBQUssT0FBTyxJQUFJLENBQUE7U0FDdEI7UUFDRCxVQUFVLEdBQUcsSUFBSSxNQUFNLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFBO0tBQ2hDO0lBQ0QsT0FBTyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0FBQzNFLENBQUM7QUEzQkQsd0NBMkJDO0FBYUQsU0FBZ0IsU0FBUyxDQUFDLE1BQWtCLEVBQUUsV0FBa0IsRUFBRSxZQUFvQixJQUFJO0lBQ3hGLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUNqQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLFdBQVcsQ0FBQTtJQUNoQyxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUs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QztBQTVCRCw0REE0QkM7QUFLRCxTQUFnQixrQkFBa0IsQ0FBQyxNQUFrQixFQUFFLFdBQWtCLEVBQUUsS0FBYTtJQUN0RixNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUE7SUFDdkUsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM5QixPQUFPLEtBQUssSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0FBQ3hDLENBQUM7QUFKRCxnREFJQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLFFBQWUsRUFBRSxLQUEyQjtJQUM1RSxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUM1RyxDQUFDO0FBRkQsOENBRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RWRpdG9yLCBUZXh0RWRpdG9yQ29tcG9uZW50LCBUZXh0QnVmZmVyLCBSYW5nZSwgUG9pbnQgfSBmcm9tIFwiYXRvbVwiXHJcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSBcImFzc2VydFwiXHJcblxyXG4vKipcclxuICogRmluZHMgdGhlIHdvcmQgYXQgdGhlIHBvc2l0aW9uLiBZb3UgY2FuIGVpdGhlciBwcm92aWRlIGEgd29yZCByZWdleCB5b3Vyc2VsZixcclxuICogb3IgaGF2ZSBBdG9tIHVzZSB0aGUgd29yZCByZWdleCBpbiBmb3JjZSBhdCB0aGUgc2NvcGVzIGF0IHRoYXQgcG9zaXRpb24sXHJcbiAqIGluIHdoaWNoIGNhc2UgaXQgdXNlcyB0aGUgb3B0aW9uYWwgaW5jbHVkZU5vbldvcmRDaGFyYWN0ZXJzLCBkZWZhdWx0IHRydWUuXHJcbiAqIChJIGtub3cgdGhhdCdzIGEgd2VpcmQgZGVmYXVsdCBidXQgaXQgZm9sbG93cyBBdG9tJ3MgY29udmVudGlvbi4uLilcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB3b3JkQXRQb3NpdGlvbihcclxuICBlZGl0b3I6IFRleHRFZGl0b3IsXHJcbiAgcG9zaXRpb246IFBvaW50LFxyXG4gIHdvcmRSZWdleD86IFJlZ0V4cCB8IHsgaW5jbHVkZU5vbldvcmRDaGFyYWN0ZXJzOiBib29sZWFuIH1cclxuKTogeyB3b3JkTWF0Y2g6IEFycmF5PHN0cmluZz47IHJhbmdlOiBSYW5nZSB9IHwgbnVsbCB7XHJcbiAgbGV0IHdvcmRSZWdleF9cclxuICBpZiAod29yZFJlZ2V4IGluc3RhbmNlb2YgUmVnRXhwKSB7XHJcbiAgICB3b3JkUmVnZXhfID0gd29yZFJlZ2V4XHJcbiAgfSBlbHNlIHtcclxuICAgIC8vIFdoYXQgaXMgdGhlIHdvcmQgcmVnZXggYXNzb2NpYXRlZCB3aXRoIHRoZSBwb3NpdGlvbj8gV2UnZCBsaWtlIHRvIHVzZVxyXG4gICAgLy8gQ3Vyc29yLndvcmRSZWdFeHAsIGV4Y2VwdCB0aGF0IGZ1bmN0aW9uIGdldHMgdGhlIHJlZ2V4IGFzc29jaWF0ZWRcclxuICAgIC8vIHdpdGggdGhlIGVkaXRvcidzIGN1cnJlbnQgY3Vyc29yIHdoaWxlIHdlIHdhbnQgdGhlIHJlZ2V4IGFzc29jaWF0ZWQgd2l0aFxyXG4gICAgLy8gdGhlIHNwZWNpZmljIHBvc2l0aW9uLiBTbyB3ZSByZS1pbXBsZW1lbnQgaXQgb3Vyc2VsdmVzLi4uXHJcbiAgICAvLyBAdHMtaWdub3JlOiBodHRwczovL2dpdGh1Yi5jb20vYXRvbS9hdG9tL2Jsb2IvYWEzYzM0YmVkYjM2MWUwOWE1MDY4ZGNlOTYyMGI0NjBhMjBjYTNmYi9zcmMvdGV4dC1lZGl0b3IuanMjTDUwMzJcclxuICAgIGNvbnN0IG5vbldvcmRDaGFyczogc3RyaW5nID0gZWRpdG9yLmdldE5vbldvcmRDaGFyYWN0ZXJzKHBvc2l0aW9uKVxyXG4gICAgY29uc3QgZXNjYXBlZCA9IG5vbldvcmRDaGFycy5yZXBsYWNlKC9bLS9cXFxcXiQqKz8uKCl8W1xcXXt9XS9nLCBcIlxcXFwkJlwiKVxyXG4gICAgLy8gV2UgY29waWVkIHRoaXMgZXNjYXBpbmcgcmVnZXggZnJvbSBDdXJzb3Iud29yZFJlZ2V4cCwgcmF0aGVyIHRoYW5cclxuICAgIC8vIHVzaW5nIHRoZSBsaWJyYXJ5IGZ1bmN0aW9uICdlc2NhcGVTdHJpbmdSZWdFeHAnLiBUaGF0J3MgYmVjYXVzZSB0aGVcclxuICAgIC8vIGxpYnJhcnkgZnVuY3Rpb24gZG9lc24ndCBlc2NhcGUgdGhlIGh5cGhlbiBjaGFyYWN0ZXIgYW5kIHNvIGlzXHJcbiAgICAvLyB1bnN1aXRhYmxlIGZvciB1c2UgaW5zaWRlIGEgcmFuZ2UuXHJcbiAgICBsZXQgciA9IGBeW1xcdCBdKiR8W15cXFxccyR7ZXNjYXBlZH1dK2BcclxuICAgIGlmICh3b3JkUmVnZXggPT0gbnVsbCB8fCB3b3JkUmVnZXguaW5jbHVkZU5vbldvcmRDaGFyYWN0ZXJzKSB7XHJcbiAgICAgIHIgKz0gYHxbJHtlc2NhcGVkfV0rYFxyXG4gICAgfVxyXG4gICAgd29yZFJlZ2V4XyA9IG5ldyBSZWdFeHAociwgXCJnXCIpXHJcbiAgfVxyXG4gIHJldHVybiB3b3JkQXRQb3NpdGlvbkZyb21CdWZmZXIoZWRpdG9yLmdldEJ1ZmZlcigpLCBwb3NpdGlvbiwgd29yZFJlZ2V4XylcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldHMgdGhlIHRyaW1tZWQgcmFuZ2UgZnJvbSBhIGdpdmVuIHJhbmdlLCBpLmUuIG1vdmVzIHRoZSBzdGFydCBhbmQgZW5kIHBvaW50c1xyXG4gKiB0byB0aGUgZmlyc3QgYW5kIGxhc3Qgbm9uLXdoaXRlc3BhY2UgY2hhcmFjdGVycyAob3Igc3BlY2lmaWVkIHJlZ2V4KVxyXG4gKiB3aXRoaW4gdGhlIHJhbmdlIHJlc3BlY3RpdmVseS5cclxuICpcclxuICogQHBhcmFtIGVkaXRvciAgICAgICB0aGUgZWRpdG9yIGNvbnRhaW5pbmcgdGhlIHJhbmdlXHJcbiAqIEBwYXJhbSByYW5nZVRvVHJpbSAgdGhlIHJhbmdlIHRvIHRyaW1cclxuICogQHBhcmFtIHN0b3BSZWdleCAgICBzdG9wIHRyaW1taW5nIHdoZW4gdGhlIGZpcnN0IG1hdGNoIGlzIGZvdW5kIGZvciB0aGlzIHJlZ2V4LFxyXG4gKiAgIGRlZmF1bHRzIHRvIGZpcnN0IG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlclxyXG4gKiBAcmV0dXJuIFJhbmdlICB0aGUgdHJpbW1lZCByYW5nZVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHRyaW1SYW5nZShlZGl0b3I6IFRleHRFZGl0b3IsIHJhbmdlVG9UcmltOiBSYW5nZSwgc3RvcFJlZ2V4OiBSZWdFeHAgPSAvXFxTLyk6IFJhbmdlIHtcclxuICBjb25zdCBidWZmZXIgPSBlZGl0b3IuZ2V0QnVmZmVyKClcclxuICBsZXQgeyBzdGFydCwgZW5kIH0gPSByYW5nZVRvVHJpbVxyXG4gIGJ1ZmZlci5zY2FuSW5SYW5nZShzdG9wUmVnZXgsIHJhbmdlVG9UcmltLCAoeyByYW5nZSwgc3RvcCB9KSA9PiB7XHJcbiAgICBzdGFydCA9IHJhbmdlLnN0YXJ0XHJcbiAgICBzdG9wKClcclxuICB9KVxyXG4gIGJ1ZmZlci5iYWNrd2FyZHNTY2FuSW5SYW5nZShzdG9wUmVnZXgsIHJhbmdlVG9UcmltLCAoeyByYW5nZSwgc3RvcCB9KSA9PiB7XHJcbiAgICBlbmQgPSByYW5nZS5lbmRcclxuICAgIHN0b3AoKVxyXG4gIH0pXHJcbiAgcmV0dXJuIG5ldyBSYW5nZShzdGFydCwgZW5kKVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRTaW5nbGVXb3JkQXRQb3NpdGlvbihlZGl0b3I6IFRleHRFZGl0b3IsIHBvc2l0aW9uOiBQb2ludCk6IHN0cmluZyB8IG51bGwge1xyXG4gIGNvbnN0IG1hdGNoID0gd29yZEF0UG9zaXRpb24oZWRpdG9yLCBwb3NpdGlvbilcclxuICAvLyBXZSBzaG91bGQgb25seSByZWNlaXZlIGEgc2luZ2xlIGlkZW50aWZpZXIgZnJvbSBhIHNpbmdsZSBwb2ludC5cclxuICBpZiAobWF0Y2ggPT0gbnVsbCB8fCBtYXRjaC53b3JkTWF0Y2gubGVuZ3RoICE9PSAxKSB7XHJcbiAgICByZXR1cm4gbnVsbFxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIG1hdGNoLndvcmRNYXRjaFswXVxyXG59XHJcblxyXG4vKipcclxuICogR2V0cyB0aGUgd29yZCBiZWluZyByaWdodC1jbGlja2VkIG9uIGluIGEgTW91c2VFdmVudC4gQSBnb29kIHVzZSBjYXNlIGZvclxyXG4gKiB0aGlzIGlzIHBlcmZvcm1pbmcgYW4gYWN0aW9uIG9uIGEgd29yZCBmcm9tIGEgY29udGV4dCBtZW51LlxyXG4gKlxyXG4gKiBAcGFyYW0gZWRpdG9yICB0aGUgZWRpdG9yIGNvbnRhaW5pbmcgdGhlIHdvcmQgd2hlcmUgdGhlIE1vdXNlRXZlbnQgb2NjdXJyZWRcclxuICogICBmcm9tXHJcbiAqIEBwYXJhbSBldmVudCAgIHRoZSBNb3VzZUV2ZW50IGNvbnRhaW5pbmcgdGhlIHNjcmVlbiBwb3NpdGlvbiBvZiB0aGUgY2xpY2tcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRXb3JkRnJvbU1vdXNlRXZlbnQoZWRpdG9yOiBUZXh0RWRpdG9yLCBldmVudDogTW91c2VFdmVudCk6IHN0cmluZyB8IG51bGwge1xyXG4gIC8vIFdlIGNhbid0IGltbWVkaWF0ZWx5IGdldCB0aGUgaWRlbnRpZmllciByaWdodC1jbGlja2VkIG9uIGZyb21cclxuICAvLyB0aGUgTW91c2VFdmVudC4gVXNpbmcgaXRzIHRhcmdldCBlbGVtZW50IGNvbnRlbnQgd291bGQgd29yayBpblxyXG4gIC8vIHNvbWUgY2FzZXMgYnV0IHdvdWxkbid0IHdvcmsgaWYgdGhlcmUgd2FzIGFkZGl0aW9uYWwgY29udGVudFxyXG4gIC8vIGluIHRoZSBzYW1lIGVsZW1lbnQsIHN1Y2ggYXMgaW4gYSBjb21tZW50LlxyXG4gIC8vIEB0cy1pZ25vcmU6IGh0dHBzOi8vZ2l0aHViLmNvbS9hdG9tL2F0b20vYmxvYi9hYTNjMzRiZWRiMzYxZTA5YTUwNjhkY2U5NjIwYjQ2MGEyMGNhM2ZiL3NyYy90ZXh0LWVkaXRvci5qcyNMNTA3NVxyXG4gIGNvbnN0IGNvbXBvbmVudDogVGV4dEVkaXRvckNvbXBvbmVudCA9IGVkaXRvci5nZXRFbGVtZW50KCkuY29tcG9uZW50XHJcbiAgaW52YXJpYW50KGNvbXBvbmVudClcclxuICAvLyBUaGlzIHNvbHV0aW9uIGRvZXNuJ3QgZmVlbCBpZGVhbCBidXQgaXQgaXMgdGhlIHdheSBoeXBlcmNsaWNrIGRvZXMgaXQuXHJcbiAgY29uc3QgcG9pbnQgPSBjb21wb25lbnQuc2NyZWVuUG9zaXRpb25Gb3JNb3VzZUV2ZW50KGV2ZW50KVxyXG4gIHJldHVybiBnZXRTaW5nbGVXb3JkQXRQb3NpdGlvbihlZGl0b3IsIHBvaW50KVxyXG59XHJcblxyXG4vKipcclxuICogQXR0ZW1wdHMgdG8gZ2V0IGEgd29yZCBmcm9tIHRoZSBsYXN0IHNlbGVjdGlvbiBvciBjdXJzb3IuIEEgZ29vZCB1c2UgY2FzZSBmb3JcclxuICogdGhpcyBpcyBwZXJmb3JtaW5nIGFuIGFjdGlvbiBvbiBhbiAnYWN0aXZlJyB3b3JkIGFmdGVyIGEgY29tbWFuZCBpcyB0cmlnZ2VyZWRcclxuICogdmlhIGEga2V5YmluZGluZy5cclxuICpcclxuICogQHBhcmFtIGVkaXRvciAgdGhlIGVkaXRvciBjb250YWluaW5nIHRoZSAnYWN0aXZlJyB3b3JkIHdoZW4gdGhlIGtleWJpbmRpbmcgaXNcclxuICogICB0cmlnZ2VyZWRcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRXb3JkRnJvbUN1cnNvck9yU2VsZWN0aW9uKGVkaXRvcjogVGV4dEVkaXRvcik6IHN0cmluZyB8IG51bGwge1xyXG4gIGNvbnN0IHNlbGVjdGlvbiA9IGVkaXRvci5nZXRTZWxlY3RlZFRleHQoKVxyXG4gIGlmIChzZWxlY3Rpb24gJiYgc2VsZWN0aW9uLmxlbmd0aCA+IDApIHtcclxuICAgIHJldHVybiBzZWxlY3Rpb25cclxuICB9XHJcblxyXG4gIC8vIFRoZXJlIHdhcyBubyBzZWxlY3Rpb24gc28gd2UgY2FuIGdvIGFoZWFkIGFuZCB0cnkgdGhlIGN1cnNvciBwb3NpdGlvbi5cclxuICBjb25zdCBwb2ludCA9IGVkaXRvci5nZXRDdXJzb3JTY3JlZW5Qb3NpdGlvbigpXHJcbiAgcmV0dXJuIGdldFNpbmdsZVdvcmRBdFBvc2l0aW9uKGVkaXRvciwgcG9pbnQpXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB3b3JkQXRQb3NpdGlvbkZyb21CdWZmZXIoXHJcbiAgYnVmZmVyOiBUZXh0QnVmZmVyLFxyXG4gIHBvc2l0aW9uOiBQb2ludCxcclxuICB3b3JkUmVnZXg6IFJlZ0V4cFxyXG4pOiB7IHdvcmRNYXRjaDogQXJyYXk8c3RyaW5nPjsgcmFuZ2U6IFJhbmdlIH0gfCBudWxsIHtcclxuICBjb25zdCB7IHJvdywgY29sdW1uIH0gPSBwb3NpdGlvblxyXG4gIGNvbnN0IHJvd1JhbmdlID0gYnVmZmVyLnJhbmdlRm9yUm93KHJvdylcclxuICBsZXQgbWF0Y2hEYXRhOiB7IG1hdGNoOiBBcnJheTxzdHJpbmc+OyByYW5nZTogUmFuZ2UgfSB8IG51bGxcclxuICAvLyBFeHRyYWN0IHRoZSBleHByZXNzaW9uIGZyb20gdGhlIHJvdyB0ZXh0LlxyXG4gIGJ1ZmZlci5zY2FuSW5SYW5nZSh3b3JkUmVnZXgsIHJvd1JhbmdlLCAoZGF0YSkgPT4ge1xyXG4gICAgY29uc3QgeyByYW5nZSB9ID0gZGF0YVxyXG4gICAgaWYgKHJhbmdlLnN0YXJ0LmlzTGVzc1RoYW5PckVxdWFsKHBvc2l0aW9uKSAmJiByYW5nZS5lbmQuaXNHcmVhdGVyVGhhbihwb3NpdGlvbikpIHtcclxuICAgICAgbWF0Y2hEYXRhID0gZGF0YVxyXG4gICAgfVxyXG4gICAgLy8gU3RvcCB0aGUgc2NhbiBpZiB0aGUgc2Nhbm5lciBoYXMgcGFzc2VkIG91ciBwb3NpdGlvbi5cclxuICAgIGlmIChyYW5nZS5lbmQuY29sdW1uID4gY29sdW1uKSB7XHJcbiAgICAgIGRhdGEuc3RvcCgpXHJcbiAgICB9XHJcbiAgfSlcclxuICAvLyBAdHMtaWdub3JlIChpdCBpcyBhc3NpZ25lZCBhYm92ZSlcclxuICBpZiAobWF0Y2hEYXRhKSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB3b3JkTWF0Y2g6IG1hdGNoRGF0YS5tYXRjaCxcclxuICAgICAgcmFuZ2U6IG1hdGNoRGF0YS5yYW5nZSxcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIG51bGxcclxuICB9XHJcbn1cclxuXHJcbi8vIE1hdGNoZXMgYSByZWdleCBvbiB0aGUgdGV4dCBvZiB0aGUgbGluZSBlbmRpbmcgYXQgZW5kUG9zaXRpb24uXHJcbi8vIHJlZ2V4IHNob3VsZCBlbmQgd2l0aCBhICckJy5cclxuLy8gVXNlZnVsIGZvciBhdXRvY29tcGxldGUuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYXRjaFJlZ2V4RW5kaW5nQXQoYnVmZmVyOiBUZXh0QnVmZmVyLCBlbmRQb3NpdGlvbjogUG9pbnQsIHJlZ2V4OiBSZWdFeHApOiBzdHJpbmcgfCBudWxsIHtcclxuICBjb25zdCBsaW5lID0gYnVmZmVyLmdldFRleHRJblJhbmdlKFtbZW5kUG9zaXRpb24ucm93LCAwXSwgZW5kUG9zaXRpb25dKVxyXG4gIGNvbnN0IG1hdGNoID0gcmVnZXguZXhlYyhsaW5lKVxyXG4gIHJldHVybiBtYXRjaCA9PSBudWxsID8gbnVsbCA6IG1hdGNoWzBdXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1Bvc2l0aW9uSW5SYW5nZShwb3NpdGlvbjogUG9pbnQsIHJhbmdlOiBSYW5nZSB8IEFycmF5PFJhbmdlPik6IGJvb2xlYW4ge1xyXG4gIHJldHVybiBBcnJheS5pc0FycmF5KHJhbmdlKSA/IHJhbmdlLnNvbWUoKHIpID0+IHIuY29udGFpbnNQb2ludChwb3NpdGlvbikpIDogcmFuZ2UuY29udGFpbnNQb2ludChwb3NpdGlvbilcclxufVxyXG4iXX0=